Sub GenererFichesPresenceUniqueFeuille()
    Dim wsEmploiDuTemps As Worksheet
    Dim wsEnseignants As Worksheet
    Dim wsFichePresence As Worksheet
    Dim jours As Variant
    Dim heuresMatin As Variant
    Dim heuresApresMidi As Variant
    Dim enseignants As Collection
    Dim jour As Variant
    Dim heure As Variant
    Dim enseignant As Variant
    Dim i As Long, j As Long, k As Long
    Dim cellule As Range
    Dim startRow As Long
    
    ' Définir les jours et les heures
    jours = Array("ÇáÅËäíä", "ÇáËáÇËÇÁ", "ÇáÇÑÈÚÇÁ", "ÇáÎãíÓ", "ÇáÌãÚÉ")
    heuresMatin = Array("9<=8", "10<=9", "11<=10", "12<=11")
    heuresApresMidi = Array("14<=13", "15<=14", "16<=15", "17<=16")
    
    ' Collecter tous les enseignants depuis l'onglet "Enseignants"
    Set enseignants = New Collection
    Set wsEnseignants = ThisWorkbook.Worksheets("Enseignants")
    For i = 2 To wsEnseignants.Cells(wsEnseignants.Rows.Count, "A").End(xlUp).row
        On Error Resume Next
        enseignants.Add wsEnseignants.Cells(i, 1).Value, CStr(wsEnseignants.Cells(i, 1).Value)
        On Error GoTo 0
    Next i
    
    ' Créer ou réinitialiser la feuille de présence
    On Error Resume Next
    Set wsFichePresence = ThisWorkbook.Worksheets("Fiches de Présence")
    On Error GoTo 0
    
    If wsFichePresence Is Nothing Then
        Set wsFichePresence = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
        wsFichePresence.Name = "Fiches de Présence"
    Else
        wsFichePresence.Cells.Clear
    End If
    
    ' Configurer l'affichage de droite à gauche
    wsFichePresence.DisplayRightToLeft = True
    
    startRow = 1
    
    ' Créer une section pour chaque jour
    For Each jour In jours
        ' Ajouter le titre
        wsFichePresence.Cells(startRow, 3).Value = "Fiche de présence - " & jour
        wsFichePresence.Cells(startRow, 3).Font.Bold = True
        wsFichePresence.Cells(startRow, 3).Font.Size = 14
        
        ' Partie Matin
        wsFichePresence.Cells(startRow + 2, 1).Value = "Matin"
        wsFichePresence.Cells(startRow + 2, 1).Font.Bold = True
        
        ' Ajouter les en-têtes des heures du matin
        For i = 1 To UBound(heuresMatin) + 1
            wsFichePresence.Cells(startRow + 3, i + 1).Value = heuresMatin(i - 1)
            wsFichePresence.Cells(startRow + 3, i + 1).Font.Bold = True
        Next i
        
        ' Ajouter les enseignants
        For i = 1 To enseignants.Count
            wsFichePresence.Cells(startRow + 3 + i, 1).Value = enseignants(i)
            wsFichePresence.Cells(startRow + 3 + i, 1).Font.Size = 14
        Next i
        
        ' Partie Après-midi
        wsFichePresence.Cells(startRow + enseignants.Count + 5, 1).Value = "Après-midi"
        wsFichePresence.Cells(startRow + enseignants.Count + 5, 1).Font.Bold = True
        
        ' Ajouter les en-têtes des heures de l'après-midi
        For i = 1 To UBound(heuresApresMidi) + 1
            wsFichePresence.Cells(startRow + enseignants.Count + 6, i + 1).Value = heuresApresMidi(i - 1)
            wsFichePresence.Cells(startRow + enseignants.Count + 6, i + 1).Font.Bold = True
        Next i
        
        ' Ajouter les enseignants pour l'après-midi
        For i = 1 To enseignants.Count
            wsFichePresence.Cells(startRow + enseignants.Count + 6 + i, 1).Value = enseignants(i)
            wsFichePresence.Cells(startRow + enseignants.Count + 6 + i, 1).Font.Size = 14
        Next i
        
        ' Remplir la fiche de présence
        Set wsEmploiDuTemps = ThisWorkbook.Worksheets("EmploiDuTemps")
        For i = 2 To wsEmploiDuTemps.Cells(wsEmploiDuTemps.Rows.Count, "A").End(xlUp).row
            If wsEmploiDuTemps.Cells(i, 5).Value = jour Then
                Dim rowIndex As Long
                Dim colIndex As Long
                Dim isMatin As Boolean
                
                isMatin = Not IsError(Application.Match(wsEmploiDuTemps.Cells(i, 6).Value, heuresMatin, 0))
                
                If isMatin Then
                    rowIndex = Application.Match(wsEmploiDuTemps.Cells(i, 4).Value, wsFichePresence.Range(wsFichePresence.Cells(startRow + 4, 1), wsFichePresence.Cells(startRow + 3 + enseignants.Count, 1)), 0)
                    colIndex = Application.Match(wsEmploiDuTemps.Cells(i, 6).Value, wsFichePresence.Range(wsFichePresence.Cells(startRow + 3, 1), wsFichePresence.Cells(startRow + 3, UBound(heuresMatin) + 2)), 0)
                Else
                    rowIndex = Application.Match(wsEmploiDuTemps.Cells(i, 4).Value, wsFichePresence.Range(wsFichePresence.Cells(startRow + enseignants.Count + 7, 1), wsFichePresence.Cells(startRow + enseignants.Count + 6 + enseignants.Count, 1)), 0)
                    colIndex = Application.Match(wsEmploiDuTemps.Cells(i, 6).Value, wsFichePresence.Range(wsFichePresence.Cells(startRow + enseignants.Count + 6, 1), wsFichePresence.Cells(startRow + enseignants.Count + 6, UBound(heuresApresMidi) + 2)), 0)
                End If
                
                If Not IsError(rowIndex) And Not IsError(colIndex) Then
                    Dim targetCell As Range
                    If isMatin Then
                        Set targetCell = wsFichePresence.Cells(startRow + 3 + rowIndex, colIndex)
                    Else
                        Set targetCell = wsFichePresence.Cells(startRow + enseignants.Count + 6 + rowIndex, colIndex)
                    End If
                    
                    With targetCell
                        .Value = wsEmploiDuTemps.Cells(i, 2).Value & vbNewLine & _
                                 wsEmploiDuTemps.Cells(i, 1).Value & vbNewLine & _
                                 wsEmploiDuTemps.Cells(i, 3).Value
                        .Font.Size = 8
                        .WrapText = True
                        .Interior.Color = RGB(240, 240, 240) ' Gris clair
                    End With
                End If
            End If
        Next i
        
        ' Ajouter des hachures gris clair inclinées aux cellules vides du matin
        Dim cellRange As Range
        For Each cellRange In wsFichePresence.Range(wsFichePresence.Cells(startRow + 4, 2), wsFichePresence.Cells(startRow + 3 + enseignants.Count, UBound(heuresMatin) + 2))
            If Len(Trim(cellRange.Value)) = 0 Then
                With cellRange.Interior
                    .Pattern = xlLightDown
                    .PatternColorIndex = xlAutomatic
                    .Color = RGB(240, 240, 240) ' Couleur gris clair pour les hachures
                    .TintAndShade = 0
                End With
            End If
        Next cellRange

        ' Ajouter des hachures gris clair inclinées aux cellules vides de l'après-midi
        For Each cellRange In wsFichePresence.Range(wsFichePresence.Cells(startRow + enseignants.Count + 7, 2), wsFichePresence.Cells(startRow + enseignants.Count * 2 + 6, UBound(heuresApresMidi) + 2))
            If Len(Trim(cellRange.Value)) = 0 Then
                With cellRange.Interior
                    .Pattern = xlLightDown
                    .PatternColorIndex = xlAutomatic
                    .Color = RGB(240, 240, 240) ' Couleur gris clair pour les hachures
                    .TintAndShade = 0
                End With
            End If
        Next cellRange
        
        ' Formater le tableau du matin
        With wsFichePresence.Range(wsFichePresence.Cells(startRow + 3, 1), wsFichePresence.Cells(startRow + 3 + enseignants.Count, UBound(heuresMatin) + 2))
            .Borders.LineStyle = xlContinuous
            .VerticalAlignment = xlCenter
            .HorizontalAlignment = xlCenter
        End With
        
        ' Formater le tableau de l'après-midi
        With wsFichePresence.Range(wsFichePresence.Cells(startRow + enseignants.Count + 6, 1), wsFichePresence.Cells(startRow + enseignants.Count * 2 + 6, UBound(heuresApresMidi) + 2))
            .Borders.LineStyle = xlContinuous
            .VerticalAlignment = xlCenter
            .HorizontalAlignment = xlCenter
        End With
        
        
        
        ' Ajuster les largeurs de colonnes et hauteurs de lignes
        wsFichePresence.Columns("A:E").ColumnWidth = 18.64
        wsFichePresence.Rows(startRow + 4 & ":" & startRow + enseignants.Count * 2 + 6).RowHeight = 52.5
        wsFichePresence.Rows(startRow + 3).RowHeight = 15 ' Hauteur normale pour l'en-tête
        wsFichePresence.Rows(startRow + enseignants.Count + 6).RowHeight = 15 ' Hauteur normale pour l'en-tête de l'après-midi
        
        ' Passer à la section suivante
        startRow = startRow + enseignants.Count * 2 + 11
    Next jour
    
    MsgBox "Fiches de présence générées pour tous les jours sur une seule feuille.", vbInformation
End Sub
